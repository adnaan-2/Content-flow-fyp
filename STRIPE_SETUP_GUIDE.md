# Stripe Integration Setup Guide\n\n## Complete Implementation Guide for Subscription System with 30-Day Free Trial\n\nThis guide will walk you through setting up a complete Stripe integration for your social media analytics platform, including the 30-day free trial system that automatically expires and requires payment.\n\n## 1. Stripe Account Setup (Pakistan-Friendly)\n\nSince Stripe business registration is not available in Pakistan, you can still use Stripe in test mode:\n\n### Option 1: Test Mode Only (Recommended for Development)\n1. Go to https://dashboard.stripe.com/register\n2. Sign up with any email (doesn't need to be Pakistani)\n3. Skip business verification for now\n4. Use test mode indefinitely for development\n5. All transactions will be simulated\n\n### Option 2: Friend/Partner in Supported Country\n1. Have a friend/partner in a Stripe-supported country create the account\n2. They can add you as a team member\n3. You can manage everything except payouts\n\n### Option 3: Use Alternative Payment Processors\n- **JazzCash/EasyPaisa**: For Pakistani users\n- **PayPal**: If you have a verified business account\n- **Razorpay**: Popular in South Asia\n- **Payoneer**: For international transactions\n\n## 2. Stripe Dashboard Setup\n\n### A. Get API Keys\n1. Go to https://dashboard.stripe.com/test/apikeys\n2. Copy the **Publishable key** (starts with `pk_test_`)\n3. Click \"Reveal test key\" and copy the **Secret key** (starts with `sk_test_`)\n\n### B. Create Products and Prices\n1. Go to https://dashboard.stripe.com/test/products\n2. Click \"+ Add Product\"\n\n**Standard Plan:**\n- Name: Standard Plan\n- Description: Ideal for growing creators\n- Pricing: $10 USD, Recurring monthly\n- Copy the Price ID (starts with `price_`)\n\n**Premium Plan:**\n- Name: Premium Plan  \n- Description: For teams and businesses\n- Pricing: $25 USD, Recurring monthly\n- Copy the Price ID (starts with `price_`)\n\n### C. Setup Webhooks (Important!)\n1. Go to https://dashboard.stripe.com/test/webhooks\n2. Click \"+ Add endpoint\"\n3. URL: `https://yourdomain.com/api/subscriptions/webhooks`\n   - For local testing: `https://your-ngrok-url.ngrok.io/api/subscriptions/webhooks`\n4. Events to listen for:\n   - `checkout.session.completed`\n   - `customer.subscription.created`\n   - `customer.subscription.updated`\n   - `customer.subscription.deleted`\n   - `invoice.payment_succeeded`\n   - `invoice.payment_failed`\n5. Copy the **Webhook Secret** (starts with `whsec_`)\n\n## 3. Environment Variables Setup\n\nAdd these to your `backend/.env` file:\n\n```bash\n# Stripe Configuration\nSTRIPE_SECRET_KEY=sk_test_your_actual_secret_key_here\nSTRIPE_PUBLISHABLE_KEY=pk_test_your_actual_publishable_key_here\nSTRIPE_WEBHOOK_SECRET=whsec_your_actual_webhook_secret_here\n\n# Stripe Price IDs (from products you created)\nSTRIPE_STANDARD_PRICE_ID=price_your_standard_price_id_here\nSTRIPE_PREMIUM_PRICE_ID=price_your_premium_price_id_here\n\n# Frontend URL for redirects\nFRONTEND_URL=http://localhost:5173\n```\n\n## 4. Install Required Packages\n\n```bash\ncd backend\nnpm install stripe\n```\n\n## 5. Test the Integration\n\n### A. Test Credit Cards (Use these in test mode)\n- **Success**: 4242 4242 4242 4242\n- **Declined**: 4000 0000 0000 0002\n- **Requires Authentication**: 4000 0025 0000 3155\n- Any future expiry date (e.g., 12/34)\n- Any 3-digit CVC\n- Any postal code\n\n### B. Testing Flow\n1. Start your backend server\n2. User signs up → Gets 30-day free trial automatically\n3. After 30 days → Trial expires, user can't access features\n4. User clicks upgrade → Redirected to Stripe checkout\n5. User pays → Webhook updates subscription → User gets access\n\n## 6. How the System Works\n\n### Free Trial (30 Days)\n- **Automatic**: Created when user signs up\n- **No Payment**: No credit card required\n- **Full Access**: All features during trial\n- **Expiration**: Automatically blocks access after 30 days\n\n### Subscription Flow\n1. **User clicks upgrade** → `POST /api/subscriptions/create-checkout-session`\n2. **Backend creates Stripe session** → Returns checkout URL\n3. **User pays on Stripe** → Stripe processes payment\n4. **Stripe sends webhook** → Backend updates subscription\n5. **User gets access** → Can use all features\n\n### Key Features Implemented\n- ✅ 30-day free trial (no payment required)\n- ✅ Automatic trial expiration\n- ✅ Subscription protection middleware\n- ✅ Real Stripe integration with webhooks\n- ✅ Mock payment mode for development\n- ✅ Plan upgrade/downgrade\n- ✅ Subscription cancellation\n- ✅ Billing history\n- ✅ Usage tracking\n\n## 7. Development vs Production\n\n### Development Mode (Current)\n- Uses Stripe test mode\n- Mock payment option available\n- No real money involved\n- Perfect for testing\n\n### Production Mode (When Ready)\n1. Get Stripe account verified (through partner/friend)\n2. Switch to live keys\n3. Update webhook URLs\n4. Test with small amounts first\n5. Implement proper error handling\n6. Add email notifications\n\n## 8. Local Testing with Ngrok (For Webhooks)\n\n```bash\n# Install ngrok\nnpm install -g ngrok\n\n# Expose your local server\nngrok http 5000\n\n# Copy the https URL and use it in Stripe webhook settings\n# Example: https://abc123.ngrok.io/api/subscriptions/webhooks\n```\n\n## 9. Alternative Payment Solutions for Pakistan\n\nIf you want to accept payments from Pakistani users:\n\n### JazzCash/EasyPaisa Integration\n```javascript\n// You can integrate these alongside Stripe\n// For Pakistani users, show local payment options\n// For international users, show Stripe\n```\n\n### PayPal Integration (if available)\n```javascript\n// PayPal can work in Pakistan with business accounts\n// Implement as alternative to Stripe\n```\n\n## 10. Important Security Notes\n\n- ✅ Never store credit card data\n- ✅ Always validate webhooks\n- ✅ Use HTTPS in production\n- ✅ Validate all user input\n- ✅ Rate limit API calls\n- ✅ Log all payment events\n\n## 11. Monitoring and Analytics\n\n### Stripe Dashboard\n- View all transactions\n- Monitor subscription metrics\n- Handle disputes and refunds\n- Generate financial reports\n\n### Your Analytics\n- Track conversion rates\n- Monitor trial-to-paid conversion\n- Identify cancellation reasons\n- Optimize pricing strategies\n\n## 12. Common Issues & Solutions\n\n### \"Stripe not configured\" Error\n- Check if STRIPE_SECRET_KEY is set\n- Verify the key starts with `sk_test_`\n- Restart your server after adding env variables\n\n### Webhook Not Working\n- Check if ngrok is running (for local testing)\n- Verify webhook URL in Stripe dashboard\n- Check webhook secret is correct\n- Look at Stripe webhook logs for errors\n\n### Payment Not Updating Subscription\n- Check webhook is receiving events\n- Verify user ID mapping in webhook handler\n- Check database connection\n- Look at server logs for errors\n\n## 13. Next Steps\n\n1. **Test the current implementation** with Stripe test mode\n2. **Add email notifications** for trial expiration\n3. **Implement proper error handling** for failed payments\n4. **Add analytics tracking** for subscription metrics\n5. **Consider multi-currency support** for international users\n6. **Plan production deployment** with proper SSL and domain\n\n## Files Modified/Created\n\n- ✅ `backend/services/stripeService.js` - Complete Stripe integration\n- ✅ `backend/routes/subscriptionRoutes.js` - Payment routes and webhooks\n- ✅ `backend/models/Subscription.js` - Enhanced with Stripe fields\n- ✅ `frontend/src/services/subscriptionApi.ts` - Stripe API calls\n- ✅ `frontend/src/pages/dashboard/Subscription.tsx` - Payment UI\n- ✅ `frontend/src/components/SubscriptionGuard.tsx` - Access protection\n\nThe system is now ready for testing! Users will get a 30-day free trial upon signup, and after expiration, they'll need to pay through Stripe to continue using the platform.\n